apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deploy
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080    # có the de trong K8s tự chọn

Tóm tắt diễn giải

Deployment nginx-deploy
Tạo ra 3 Pod, mỗi Pod có 1 container chạy nginx mở port 80.
Dùng label app: nginx (ở dòng 11) để biết Pod nào là “con” của nó.
Khi Deployment tạo Pod, nó sẽ gắn label app: nginx (ở dòng 15).
Nếu label ở dòng 15 khác với dòng 11 → Pod vẫn được tạo, nhưng không được ReplicaSet/Deployment quản lý (nghĩa là chết thì không tự phục hồi).
nhản dòng 6 chỉ để “đặt nhãn” cho chính Deployment (nên giữ giống để dễ đọc).
18) chỉ là tên container, không liên quan đến label/selector.

```
root@master01:~# kubectl get pod -o wide
NAME                            READY   STATUS    RESTARTS   AGE     IP              NODE       NOMINATED NODE   READINESS GATES
nginx-deploy-54b9c68f67-ggk8n   1/1     Running   0          2m15s   192.168.5.7     worker01   <none>           <none>
nginx-deploy-54b9c68f67-tjz9s   1/1     Running   0          2m15s   192.168.19.71   worker03   <none>           <none>
nginx-deploy-54b9c68f67-wwgbt   1/1     Running   0          2m15s   192.168.30.67   worker02   <none>           <none>
root@master01:~#
root@master01:~#
root@master01:~#
root@master01:~#
root@master01:~# kubectl get svc
NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
kubernetes      ClusterIP   10.96.0.1      <none>        443/TCP        52d
nginx-service   NodePort    10.99.93.158   <none>        80:30080/TCP   2m23s
```
net 192.168.5 là do CNI calico cấp



từ ngoài cluster truy cập đến 1 trong 3 node worker trên port 80 sẽ được kube-proxy bắt gói
kube-proxy đã cài sẵn iptables rule sẽ chuyển hướng nội bộ (DNAT NodeIP:30080) thành ClusterIP:80
kube-proxy tiếp tục xử lý ClusterIP DNAT cluster IP thành Pod IP
Calico định tuyến gói tin đến đúng Node
cần có 1 cơ chế để tự động chọn 1 trong 3 node worker đó là load balance or HA Proxy or Ingress
Ở đây dùng nodeport + Ha proxy
trên Haproxy bổ sung cấp hình sau vào file config
Load balance NodePort service nginx
frontend nginx-frontend
    bind *:443 ssl crt /etc/haproxy/certs/nginx.pem
    mode http
    option httplog
    default_backend nginx-backend

backend nginx-backend
    mode http
    balance roundrobin
    option httpchk GET /
    server worker-01 10.0.0.11:30080 check
    server worker-02 10.0.0.12:30080 check
    server worker-03 10.0.0.13:30080 check
file nginx.pem gồm nội dung fullchain và privkey. cấp quyền chmod 600

